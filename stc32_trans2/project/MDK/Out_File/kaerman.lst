C251 COMPILER V5.60.0,  kaerman                                                            17/07/23  20:03:17  PAGE 1   


C251 COMPILER V5.60.0, COMPILATION OF MODULE kaerman
OBJECT MODULE PLACED IN .\Out_File\kaerman.obj
COMPILER INVOKED BY: D:\Program files\Keil251\C251\BIN\C251.EXE ..\CODE\kaerman.c LARGE INTR2 WARNINGLEVEL(3) OPTIMIZE(0
                    -,SPEED) BROWSE INCDIR(..\..\Libraries\libraries;..\..\Libraries\seekfree_libraries;..\..\Libraries\seekfree_peripheral;.
                    -.\CODE;..\USER\inc;..\USER\src) DEBUG PRINT(.\Out_File\kaerman.lst) TABS(2) OBJECT(.\Out_File\kaerman.obj) 

stmt  level    source

    1          #include "kaerman.h"
    2          
    3          float accel_x;      // XÖá¼ÓËÙ¶ÈÖµ
    4          float accel_y;      // YÖá¼ÓËÙ¶ÈÖµ
    5          float accel_z;      // ZÖá¼ÓËÙ¶ÈÖµ
    6          float gyro_x;       // XÖáÍÓÂİÒÇ½ÇËÙ¶ÈÊı¾İ
    7          float gyro_y;       // YÖáÍÓÂİÒÇ½ÇËÙ¶ÈÊı¾İ
    8          float gyro_z;       // ZÖáÍÓÂİÒÇ½ÇËÙ¶ÈÊı¾İ
    9          float accel_x_rea;  // XÖá¼ÓËÙ¶ÈÖµ
   10          float accel_y_rea;  // YÖá¼ÓËÙ¶ÈÖµ
   11          float accel_z_rea;  // ZÖá¼ÓËÙ¶ÈÖµ
   12          float gyro_x_rea;   // XÖáÍÓÂİÒÇ½ÇËÙ¶ÈÊı¾İ
   13          float gyro_y_rea;   // YÖáÍÓÂİÒÇ½ÇËÙ¶ÈÊı¾İ
   14          float gyro_z_rea;   // ZÖáÍÓÂİÒÇ½ÇËÙ¶ÈÊı¾İ
   15          float yaw_raw;      //º½Ïß½ÇyawÔ­Ê¼Êı¾İ
   16          float yaw_kalman;   // yawÂË²¨ºóÊı¾İ
   17          float pitch_kalman; // pitchÂË²¨ºóÊı¾İ
   18          float pitch_raw;    //¸©Ñö½ÇpitchÔ­Ê¼Êı¾İ
   19          float roll_kalman;  // rollÂË²¨ºóÊı¾İ
   20          float roll_raw;     //ºá¹ö½ÇrollÔ­Ê¼Êı¾İ
   21          
   22          //¿¨¶ûÂüÂË²¨£¨¾É£©
   23          static double p_last = 0;
   24          static double x_last = 0;
   25          double R = 0.1; //ÂË²¨²ÎÊı£¬Ô½Ğ¡Ô½Æ½»¬
   26          double Q = 15;  //ÂË²¨²ÎÊı£¬Ô½´óÔ½Æ½»¬
   27          double KalmanFilter(const double ResrcData)
   28          {
   29   1      
   30   1        double x_mid;
   31   1        double x_now;
   32   1      
   33   1        double p_mid;
   34   1        double p_now;
   35   1      
   36   1        double kg;
   37   1      
   38   1        //ÕâÀïp_last µÈÓÚ kalmanFilter_A µÄpÖ±½ÓÈ¡0
   39   1        x_mid = x_last;     // x_last=x(k-1|k-1),x_mid=x(k|k-1)
   40   1        p_mid = p_last + Q; // p_mid=p(k|k-1),p_last=p(k-1|k-1),Q=ÔëÉù
   41   1      
   42   1        /*
   43   1         *  ¿¨¶ûÂüÂË²¨µÄÎå¸öÖØÒª¹«Ê½
   44   1         */
   45   1        kg = p_mid / (p_mid + R);                 // kgÎªkalman filter£¬R ÎªÔëÉù
   46   1        x_now = x_mid + kg * (ResrcData - x_mid); //¹À¼Æ³öµÄ×îÓÅÖµ
   47   1        p_now = (1 - kg) * p_mid;                 //×îÓÅÖµ¶ÔÓ¦µÄcovariance
   48   1        p_last = p_now;                           //¸üĞÂcovariance Öµ
   49   1        x_last = x_now;                           //¸üĞÂÏµÍ³×´Ì¬Öµ
   50   1      
   51   1        return x_now;
   52   1      }
   53          
   54          void Angle_Cal()
   55          {
   56   1        imu963ra_get_acc();
   57   1        imu963ra_get_gyro();
C251 COMPILER V5.60.0,  kaerman                                                            17/07/23  20:03:17  PAGE 2   

   58   1        // 1.»ñÈ¡¼ÓËÙ¶ÈºÍ½Ç¶ÈÊı¾İ
   59   1        accel_x = imu963ra_acc_x;
   60   1        accel_y = imu963ra_acc_y;
   61   1        accel_z = imu963ra_acc_z;
   62   1        gyro_x = imu963ra_gyro_x;
   63   1        gyro_y = imu963ra_gyro_y;
   64   1        gyro_z = imu963ra_gyro_z;
   65   1      
   66   1        // 2.½Ç¼ÓËÙ¶ÈÔ­Ê¼Öµ´¦Àí¹ı³Ì
   67   1        if (accel_x < 32764)
   68   1          accel_x_rea = accel_x / 4098.0;
   69   1        else
   70   1          accel_x_rea = 1 - (accel_x - 49152) / 4098.0;
   71   1        if (accel_y < 32764)
   72   1          accel_y_rea = accel_y / 4098.0;
   73   1        else
   74   1          accel_y_rea = 1 - (accel_y - 49152) / 4098.0;
   75   1        if (accel_z < 32764)
   76   1          accel_z_rea = accel_z / 4098.0;
   77   1        else
   78   1          accel_z_rea = 1 - (accel_z - 49152) / 4098.0;
   79   1      
   80   1        //¼ÓËÙ¶È·´ÕıÇĞ¹«Ê½¼ÆËãÈı¸öÖáºÍË®Æ½Ãæ×ø±êÏµÖ®¼äµÄ¼Ğ½Ç
   81   1        pitch_raw = (atan(accel_y_rea / accel_z_rea)) * 180 / 3.14;
   82   1        roll_raw = (atan(accel_x_rea / accel_z_rea)) * 180 / 3.14;
   83   1        yaw_raw = (atan(accel_y_rea / accel_x_rea)) * 180 / 3.14;
   84   1      
   85   1        // 3.½ÇËÙ¶ÈÔ­Ê¼Öµ´¦Àí¹ı³Ì
   86   1        if (gyro_x_rea < 32768)
   87   1          gyro_x_rea = -(gyro_x_rea / 14.3);
   88   1        if (gyro_x_rea > 32768)
   89   1          gyro_x_rea = +(65535 - gyro_x_rea) / 14.3;
   90   1        if (gyro_y_rea < 32768)
   91   1          gyro_y_rea = -(gyro_y_rea / 14.3);
   92   1        if (gyro_y_rea > 32768)
   93   1          gyro_y_rea = +(65535 - gyro_y_rea) / 14.3;
   94   1        if (gyro_z_rea < 32768)
   95   1          gyro_z_rea = -(gyro_z_rea / 14.3);
   96   1        if (gyro_z_rea > 32768)
   97   1          gyro_z_rea = +(65535 - gyro_z_rea) / 14.3;
   98   1      
   99   1        // 4.µ÷ÓÃ¿¨¶ûÂüº¯Êı
  100   1        Kalman_Cal_Pitch(pitch_raw, gyro_x_rea); //¿¨¶ûÂüÂË²¨¼ÆËã¸©Ñö½Ç
  101   1                                                 // Kalman_Cal_Roll(roll_raw,gyro_y_rea);  //¿¨¶ûÂüÂË²¨¼ÆËãÇãĞ±
             -½Ç
  102   1                                                 // Kalman_Cal_Yaw(yaw_raw,gyro_z_rea);  //¿¨¶ûÂüÂË²¨¼ÆËãÆ«º½½Ç
  103   1          if (pitch_kalman > 15)
  104   1          {
  105   2            puodao = 1;
  106   2          }
  107   1          else if(puodao == 1  && pitch_kalman < -10)
  108   1          {
  109   2            puodao = 2;
  110   2          }
  111   1         else if(puodao == 2  && pitch_kalman <5)
  112   1          {
  113   2            puodao = 0;
  114   2          }
  115   1          else
  116   1          {
  117   2            puodao = 0;
  118   2          }
  119   1      }
  120          
  121          //¿¨¶ûÂü²ÎÊı
  122          static float Q_angle = 0.0003; //½Ç¶ÈÊı¾İÖÃĞÅ¶È£¬½Ç¶ÈÔëÉùµÄĞ­·½²î
C251 COMPILER V5.60.0,  kaerman                                                            17/07/23  20:03:17  PAGE 3   

  123          static float Q_gyro = 0.0009;  //½ÇËÙ¶ÈÊı¾İÖÃĞÅ¶È£¬½ÇËÙ¶ÈÔëÉùµÄĞ­·½²î
  124          static float R_angle = 0.8;    //¼ÓËÙ¶È¼Æ²âÁ¿ÔëÉùµÄĞ­·½²î
  125          static float dt = 0.005;       //²ÉÑùÖÜÆÚ¼´¼ÆËãÈÎÎñÖÜÆÚ5ms
  126          
  127          void Kalman_Cal_Pitch(float acc, float gyro) //¿¨¶ûÂüÂË²¨pitchÖá¼ÆËã
  128          {
  129   1        static float Q_bias0;                      // Q_bias:ÍÓÂİÒÇµÄÆ«²î
  130   1        static float K_00, K_10;                   //¿¨¶ûÂüÔöÒæ  K_0:ÓÃÓÚ¼ÆËã×îÓÅ¹À¼ÆÖµ  K_1:ÓÃÓÚ¼ÆËã×îÓÅ¹À¼ÆÖµ
             -µÄÆ«²î t_0/1:ÖĞ¼ä±äÁ¿
  131   1        static float PP0[2][2] = {{1, 0}, {0, 1}}; //¹ı³ÌĞ­·½²î¾ØÕóP£¬³õÊ¼ÖµÎªµ¥Î»Õó
  132   1      
  133   1        /*
  134   1          ¿¨¶ûÂüÂË²¨µÄÊ¹ÓÃ²½Öè
  135   1          (1) Ñ¡Ôñ×´Ì¬Á¿¡¢¹Û²âÁ¿
  136   1          (2) ¹¹½¨·½³Ì
  137   1          (3) ³õÊ¼»¯²ÎÊı
  138   1          (4) ´øÈë¹«Ê½µü´ú
  139   1          (5) µ÷½Ú³¬²ÎÊıP¡¢Q
  140   1        */
  141   1        /*
  142   1        X(k)£ºkÊ±¿ÌÏµÍ³×´Ì¬       Z(k)£ºkÊ±¿Ì²âÁ¿Öµ
  143   1        U(k)£ºkÊ±¿Ì¶ÔÏµÍ³¿ØÖÆÁ¿   H£º²âÁ¿ÏµÍ³²ÎÊı
  144   1                                                 ·½²î
  145   1        A/F£º×´Ì¬×ªÒÆ¾ØÕó         W(k)£º¹ı³ÌÔëÉù ----> Q
  146   1                                                 ·½²î
  147   1        B£º¿ØÖÆ¾ØÕó               V(k)£º²âÁ¿ÔëÉù ----> R
  148   1      
  149   1                          ÀëÉ¢¿ØÖÆÏµÍ³
  150   1        ÏµÍ³ÃèÊö£ºX(k|k-1) = AX(k-1|k-1) + BU(k) + (W(k))
  151   1        ²âÁ¿Öµ£ºZ(k) = HX(k) + V(k)
  152   1        */
  153   1        /*
  154   1        1. ÏÈÑé¹À¼Æ
  155   1      * * *¹«Ê½1£ºX(k|k-1) = AX(k-1|k-1) + BU(k) + (W(k))
  156   1      
  157   1          X = (Angle,Q_bias)
  158   1          A(1,1) = 1,A(1,2) = -dt
  159   1          A(2,1) = 0,A(2,2) = 1
  160   1          ×¢£ºÉÏÏÂÁ¬¡°[¡±´ú±í¾ØÕó
  161   1          Ô¤²âµ±Ç°½Ç¶ÈÖµ£º
  162   1          [ angle ]   [1 -dt][ angle ]   [dt]
  163   1          [ Q_bias] = [0  1 ][ Q_bias] + [ 0] * newGyro(¼ÓËÙ¶È¼Æ²âÁ¿Öµ)
  164   1          ¹Ê
  165   1          angle = angle - Q_bias*dt + newGyro * dt
  166   1          Q_bias = Q_bias
  167   1        */
  168   1        pitch_kalman += (gyro - Q_bias0) * dt; //×´Ì¬·½³Ì,½Ç¶ÈÖµµÈÓÚÉÏ´Î×îÓÅ½Ç¶È¼Ó½ÇËÙ¶È¼õÁãÆ¯ºó»ı·Ö
  169   1      
  170   1        /*
  171   1        2. Ô¤²âĞ­·½²î¾ØÕó
  172   1      * * *¹«Ê½2£ºP(k|k-1)=AP(k-1|k-1)A^T + Q
  173   1      
  174   1          ÓÉÏÈÑé¹À¼ÆÓĞÏµÍ³²ÎÊı
  175   1              [1 -dt]
  176   1          A = [0  1 ]
  177   1      
  178   1          ÏµÍ³¹ı³ÌĞ­·½²îÔëÉùQ¶¨Òå£º
  179   1          | cov(angle,angle)  cov(Q_bias,angle) |
  180   1          | cov(angle,Q_bias) cov(Q_bias,Q_bias)|
  181   1             ½Ç¶ÈÔëÉùºÍ½ÇËÙ¶ÈÆ¯ÒÆÔëÉùÏà»¥¶ÀÁ¢
  182   1          | D( angle )        0    |
  183   1        = |     0       D( Q_bias )|
  184   1          ÓÖQ_angleºÍQ_biasµÄ·½²îÎª³£Êı£¬
  185   1          ¿ÉÓÉ¾­Ñé»ò¼ÆËãµÃ³ö
  186   1      
  187   1          ÁîD( angle )  = Q_angle
C251 COMPILER V5.60.0,  kaerman                                                            17/07/23  20:03:17  PAGE 4   

  188   1            D( Q_bias ) = Q_gyro
  189   1      
  190   1          ÉèÉÏÒ»´ÎÔ¤²âĞ­·½²î¾ØÕóÎªP(k-1)
  191   1                            |a(k-1)  b(k-1)|
  192   1                            |c(k-1)  d(k-1)|
  193   1          ±¾´ÎÔ¤²âĞ­·½²î¾ØÕóP(k)
  194   1                            |a(k)  b(k)|
  195   1                            |c(k)  d(k)|
  196   1          ÓÉ¹«Ê½2£ºP(k|k-1)=AP(k-1|k-1)A^T + Q µÃ
  197   1          |a(k)  b(k)|    |1 -dt| |a(k-1) b(k-1)| |1   0|   | D( angle )        0    |
  198   1          |c(k)  d(k)| =  |0  1 | |c(k-1) d(k-1)| |-dt 1| + |     0       D( Q_bias )|
  199   1      
  200   1          ½øÒ»²½µÃ
  201   1          |a(k)  b(k)|    |a(k-1) - [c(k-1) + b(k-1)]*dt + d(dt)^2    b(k-1) - d(k-1)*dt|   | D( angle )        0    |
  202   1          |c(k)  d(k)| =  |       c(k-1) - d(k-1)*dt                          d(k-1)    | + |     0       D( Q_bias )|
  203   1      
  204   1          ÓÉÓÚdt^2Ì«Ğ¡£¬¹Êdt^2Ê¡ÂÔ
  205   1        */
  206   1      
  207   1        PP0[0][0] = PP0[0][0] + Q_angle - (PP0[0][1] + PP0[1][0]) * dt;
  208   1        PP0[0][1] = PP0[0][1] - PP0[1][1] * dt;
  209   1        PP0[1][0] = PP0[1][0] - PP0[1][1] * dt;
  210   1        PP0[1][1] = PP0[1][1] + Q_gyro;
  211   1      
  212   1        /*
  213   1          3. ½¨Á¢²âÁ¿·½³Ì
  214   1            ÏµÍ³²âÁ¿·½³Ì Z(k) = HX(k) + V(k)
  215   1            ÏµÍ³²âÁ¿ÏµÊı H = [1, 0]
  216   1            ÒòÎªÍÓÂİÒÇÊä³ö×Ô´øÔëÉù
  217   1            ËùÒÔ
  218   1            measure = newAngle
  219   1        */
  220   1      
  221   1        /*
  222   1          4. ¼ÆËã¿¨¶ûÂüÔöÒæ
  223   1      * * *¹«Ê½3£ºKg(k)= P(k|k-1)H^T/(HP(k|k-1)H^T+R)
  224   1              Kg = (K_0,K_1) ¶ÔÓ¦angle,Q_biasÔöÒæ
  225   1              H = (1,0)
  226   1        */
  227   1        K_00 = PP0[0][0] / (PP0[0][0] + R_angle);
  228   1        K_10 = PP0[1][0] / (PP0[0][0] + R_angle);
  229   1      
  230   1        /*
  231   1          5. ¼ÆËãµ±Ç°×îÓÅ»¯¹À¼ÆÖµ
  232   1      * * *¹«Ê½4£ºX(k|k) = X(k|k-1) + kg(k)[z(k) - HX(k|k-1)]
  233   1          angle = angle + K_0*(newAngle - angle)
  234   1          Q_bias = Q_bias + K_1*(newAngle - angle)
  235   1        */
  236   1      
  237   1        pitch_kalman = pitch_kalman + K_00 * (acc - pitch_kalman);
  238   1        Q_bias0 = Q_bias0 + K_10 * (acc - pitch_kalman);
  239   1      
  240   1        /*
  241   1          6. ¸üĞÂĞ­·½²î¾ØÕó
  242   1      * * *¹«Ê½5£ºP(k|k)=[I-Kg(k)H]P(k|k-1)
  243   1        */
  244   1        PP0[0][0] = PP0[0][0] - K_00 * PP0[0][0];
  245   1        PP0[0][1] = PP0[0][1] - K_00 * PP0[0][1];
  246   1        PP0[1][0] = PP0[1][0] - K_10 * PP0[0][0];
  247   1        PP0[1][1] = PP0[1][1] - K_10 * PP0[00][1];
  248   1      }
  249          
  250          void Kalman_Cal_Roll(float acc, float gyro) //¿¨¶ûÂüÂË²¨rollÖá¼ÆËã
  251          {
  252   1        static float Q_bias;                      // Q_bias:ÍÓÂİÒÇµÄÆ«²î  Angle_err:½Ç¶ÈÆ«Á¿
  253   1        static float K_0, K_1;                    //¿¨¶ûÂüÔöÒæ  K_0:ÓÃÓÚ¼ÆËã×îÓÅ¹À¼ÆÖµ  K_1:ÓÃÓÚ¼ÆËã×îÓÅ¹À¼ÆÖµµ
C251 COMPILER V5.60.0,  kaerman                                                            17/07/23  20:03:17  PAGE 5   

             -ÄÆ«²î t_0/1:ÖĞ¼ä±äÁ¿
  254   1        static float PP[2][2] = {{1, 0}, {0, 1}}; //¹ı³ÌĞ­·½²î¾ØÕóP£¬³õÊ¼ÖµÎªµ¥Î»Õó
  255   1        roll_kalman += (gyro - Q_bias) * dt;      //×´Ì¬·½³Ì,½Ç¶ÈÖµµÈÓÚÉÏ´Î×îÓÅ½Ç¶È¼Ó½ÇËÙ¶È¼õÁãÆ¯ºó»ı·Ö
  256   1        PP[0][0] = PP[0][0] + Q_angle - (PP[0][1] + PP[1][0]) * dt;
  257   1        PP[0][1] = PP[0][1] - PP[1][1] * dt;
  258   1        PP[1][0] = PP[1][0] - PP[1][1] * dt;
  259   1        PP[1][1] = PP[1][1] + Q_gyro;
  260   1        K_0 = PP[0][0] / (PP[0][0] + R_angle);
  261   1        K_1 = PP[1][0] / (PP[0][0] + R_angle);
  262   1        roll_kalman = roll_kalman + K_0 * (acc - roll_kalman);
  263   1        Q_bias = Q_bias + K_1 * (acc - roll_kalman);
  264   1        PP[0][0] = PP[0][0] - K_0 * PP[0][0];
  265   1        PP[0][1] = PP[0][1] - K_0 * PP[0][1];
  266   1        PP[1][0] = PP[1][0] - K_1 * PP[0][0];
  267   1        PP[1][1] = PP[1][1] - K_1 * PP[0][1];
  268   1      }
  269          
  270          void Kalman_Cal_Yaw(float acc, float gyro) //¿¨¶ûÂüÂË²¨rollÖá¼ÆËã
  271          {
  272   1        static float Q_bias;                      // Q_bias:ÍÓÂİÒÇµÄÆ«²î  Angle_err:½Ç¶ÈÆ«Á¿
  273   1        static float K_0, K_1;                    //¿¨¶ûÂüÔöÒæ  K_0:ÓÃÓÚ¼ÆËã×îÓÅ¹À¼ÆÖµ  K_1:ÓÃÓÚ¼ÆËã×îÓÅ¹À¼ÆÖµµ
             -ÄÆ«²î t_0/1:ÖĞ¼ä±äÁ¿
  274   1        static float PP[2][2] = {{1, 0}, {0, 1}}; //¹ı³ÌĞ­·½²î¾ØÕóP£¬³õÊ¼ÖµÎªµ¥Î»Õó
  275   1        yaw_kalman += (gyro - Q_bias) * dt;       //×´Ì¬·½³Ì,½Ç¶ÈÖµµÈÓÚÉÏ´Î×îÓÅ½Ç¶È¼Ó½ÇËÙ¶È¼õÁãÆ¯ºó»ı·Ö
  276   1        PP[0][0] = PP[0][0] + Q_angle - (PP[0][1] + PP[1][0]) * dt;
  277   1        PP[0][1] = PP[0][1] - PP[1][1] * dt;
  278   1        PP[1][0] = PP[1][0] - PP[1][1] * dt;
  279   1        PP[1][1] = PP[1][1] + Q_gyro;
  280   1        K_0 = PP[0][0] / (PP[0][0] + R_angle);
  281   1        K_1 = PP[1][0] / (PP[0][0] + R_angle);
  282   1        yaw_kalman = yaw_kalman + K_0 * (acc - yaw_kalman);
  283   1        Q_bias = Q_bias + K_1 * (acc - yaw_kalman);
  284   1        PP[0][0] = PP[0][0] - K_0 * PP[0][0];
  285   1        PP[0][1] = PP[0][1] - K_0 * PP[0][1];
  286   1        PP[1][0] = PP[1][0] - K_1 * PP[0][0];
  287   1        PP[1][1] = PP[1][1] - K_1 * PP[0][1];
  288   1      }


Module Information          Static   Overlayable
------------------------------------------------
  code size            =      3469     ------
  ecode size           =    ------     ------
  data size            =    ------     ------
  idata size           =    ------     ------
  pdata size           =    ------     ------
  xdata size           =       236     ------
  xdata-const size     =    ------     ------
  edata size           =    ------     ------
  bit size             =    ------     ------
  ebit size            =    ------     ------
  bitaddressable size  =    ------     ------
  ebitaddressable size =    ------     ------
  far data size        =    ------     ------
  huge data size       =    ------     ------
  const size           =    ------     ------
  hconst size          =       135     ------
End of Module Information.


C251 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
