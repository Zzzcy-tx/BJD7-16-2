C251 COMPILER V5.60.0,  SEEKFREE_DL1B                                                      13/07/23  14:12:17  PAGE 1   


C251 COMPILER V5.60.0, COMPILATION OF MODULE SEEKFREE_DL1B
OBJECT MODULE PLACED IN .\Out_File\SEEKFREE_DL1B.obj
COMPILER INVOKED BY: D:\keil5\C251\BIN\C251.EXE ..\..\Libraries\seekfree_peripheral\SEEKFREE_DL1B.c LARGE INTR2 WARNINGL
                    -EVEL(3) OPTIMIZE(0,SPEED) BROWSE INCDIR(..\..\Libraries\libraries;..\..\Libraries\seekfree_libraries;..\..\Libraries\see
                    -kfree_peripheral;..\CODE;..\USER\inc;..\USER\src) DEBUG PRINT(.\Out_File\SEEKFREE_DL1B.lst) OBJECT(.\Out_File\SEEKFREE_D
                    -L1B.obj) 

stmt  level    source

    1          /********************************************************************************************************
             -*************
    2          * MM32F527X-E9P Opensourec Library å³ï¼ˆMM32F527X-E9P å¼€æºåº“ï¼‰æ˜¯ä¸€ä¸ªåŸºäºå®˜æ–¹ SDK æ¥å£çš„ç¬¬
             -ä¸‰æ–¹å¼€æºåº“
    3          * Copyright (c) 2022 SEEKFREE é€é£ç§‘æŠ€
    4          * 
    5          * æœ¬æ–‡ä»¶æ˜¯ MM32F527X-E9P å¼€æºåº“çš„ä¸€éƒ¨åˆ†
    6          * 
    7          * MM32F527X-E9P å¼€æºåº“ æ˜¯å…è´¹è½¯ä»¶
    8          * æ‚¨å¯ä»¥æ ¹æ®è‡ªç”±è½¯ä»¶åŸºé‡‘ä¼šå‘å¸ƒçš„ GPLï¼ˆGNU General Public Licenseï¼Œå³ GNUé€šç”¨å…¬å…±è®¸
             -å¯è¯ï¼‰çš„æ¡æ¬¾
    9          * å³ GPL çš„ç¬¬3ç‰ˆï¼ˆå³ GPL3.0ï¼‰æˆ–ï¼ˆæ‚¨é€‰æ‹©çš„ï¼‰ä»»ä½•åæ¥çš„ç‰ˆæœ¬ï¼Œé‡æ–°å‘å¸ƒå’Œ/æˆ–ä¿®æ”
             -¹å®ƒ
   10          * 
   11          * æœ¬å¼€æºåº“çš„å‘å¸ƒæ˜¯å¸Œæœ›å®ƒèƒ½å‘æŒ¥ä½œç”¨ï¼Œä½†å¹¶æœªå¯¹å…¶ä½œä»»ä½•çš„ä¿è¯
   12          * ç”šè‡³æ²¡æœ‰éšå«çš„é€‚é”€æ€§æˆ–é€‚åˆç‰¹å®šç”¨é€”çš„ä¿è¯
   13          * æ›´å¤šç»†èŠ‚è¯·å‚è§ GPL
   14          * 
   15          * æ‚¨åº”è¯¥åœ¨æ”¶åˆ°æœ¬å¼€æºåº“çš„åŒæ—¶æ”¶åˆ°ä¸€ä»½ GPL çš„å‰¯æœ¬
   16          * å¦‚æœæ²¡æœ‰ï¼Œè¯·å‚é˜…<https://www.gnu.org/licenses/>
   17          * 
   18          * é¢å¤–æ³¨æ˜ï¼š
   19          * æœ¬å¼€æºåº“ä½¿ç”¨ GPL3.0 å¼€æºè®¸å¯è¯åè®® ä»¥ä¸Šè®¸å¯ç”³æ˜ä¸ºè¯‘æ–‡ç‰ˆæœ¬
   20          * è®¸å¯ç”³æ˜è‹±æ–‡ç‰ˆåœ¨ libraries/doc æ–‡ä»¶å¤¹ä¸‹çš„ GPL3_permission_statement.txt æ–‡ä»¶ä¸­
   21          * è®¸å¯è¯å‰¯æœ¬åœ¨ libraries æ–‡ä»¶å¤¹ä¸‹ å³è¯¥æ–‡ä»¶å¤¹ä¸‹çš„ LICENSE æ–‡ä»¶
   22          * æ¬¢è¿å„ä½ä½¿ç”¨å¹¶ä¼ æ’­æœ¬ç¨‹åº ä½†ä¿®æ”¹å†…å®¹æ—¶å¿…é¡»ä¿ç•™é€é£ç§‘æŠ€çš„ç‰ˆæƒå£°æ˜ï¼ˆå³æœ¬
             -å£°æ˜ï¼‰
   23          * 
   24          * æ–‡ä»¶åç§°          zf_device_dl1b
   25          * å…¬å¸åç§°          æˆéƒ½é€é£ç§‘æŠ€æœ‰é™å…¬å¸
   26          * ç‰ˆæœ¬ä¿¡æ¯          æŸ¥çœ‹ libraries/doc æ–‡ä»¶å¤¹å†… version æ–‡ä»¶ ç‰ˆæœ¬è¯´æ˜
   27          * å¼€å‘ç¯å¢ƒ          MDK 5.37
   28          * é€‚ç”¨å¹³å°          MM32F527X_E9P
   29          * åº—é“ºé“¾æ¥          https://seekfree.taobao.com/
   30          * 
   31          * ä¿®æ”¹è®°å½•
   32          * æ—¥æœŸ              ä½œè€…                å¤‡æ³¨
   33          * 2022-08-10        Teternal            first version
   34          *********************************************************************************************************
             -***********/
   35          /********************************************************************************************************
             -*************
   36          * æ¥çº¿å®šä¹‰ï¼š
   37          *                   ------------------------------------
   38          *                   æ¨¡å—ç®¡è„š            å•ç‰‡æœºç®¡è„š
   39          *                   SCL                 æŸ¥çœ‹ zf_device_dl1b.h ä¸­ DL1B_SCL_PIN  å®å®šä¹‰
   40          *                   SDA                 æŸ¥çœ‹ zf_device_dl1b.h ä¸­ DL1B_SDA_PIN  å®å®šä¹‰
   41          *                   XS                  æŸ¥çœ‹ zf_device_dl1b.h ä¸­ DL1B_XS_PIN  å®å®šä¹‰
   42          *                   VCC                 5V ç”µæº
   43          *                   GND                 ç”µæºåœ°
   44          *                   ------------------------------------
   45          *********************************************************************************************************
             -***********/
   46          
   47          #include "zf_delay.h"
   48          #include "SEEKFREE_DL1B.h"
C251 COMPILER V5.60.0,  SEEKFREE_DL1B                                                      13/07/23  14:12:17  PAGE 2   

   49          #include "SEEKFREE_CONFIG.h"
   50          
   51          uint8 dl1b_init_flag = 0;
   52          uint8 dl1b_finsh_flag = 0;
   53          uint16 dl1b_distance_mm = 8192;
   54          
   55          
   56          
   57          #define dl1b_transfer_8bit_array(tdata, tlen, rdata, rlen)      (dl1b_iic_transfer_8bit_array((tdata), (t
             -len), (rdata), (rlen)))
   58          
   59          
   60          #define GET_DL1B_SDA                            DL1B_SDA_PIN
   61          #define DL1B_SDA_LOW()                  DL1B_SDA_PIN = 0                //IOå£è¾“å‡ºä½ç”µå¹³
   62          #define DL1B_SDA_HIGH()                 DL1B_SDA_PIN = 1                //IOå£è¾“å‡ºé«˜ç”µå¹³
   63          
   64          #define DL1B_SCL_LOW()                  DL1B_SCL_PIN = 0                //IOå£è¾“å‡ºä½ç”µå¹³
   65          #define DL1B_SCL_HIGH()                 DL1B_SCL_PIN = 1                //IOå£è¾“å‡ºé«˜ç”µå¹³
   66          
   67          #define ack 1      //ä¸»åº”ç­”
   68          #define no_ack 0   //ä»åº”ç­”  
   69          
   70          //-------------------------------------------------------------------------------------------------------
             -------------
   71          //  @brief      æ¨¡æ‹ŸIICå»¶æ—¶
   72          //  @return     void                                            
   73          //  @since      v1.0
   74          //  Sample usage:                               å¦‚æœIICé€šè®¯å¤±è´¥å¯ä»¥å°è¯•å¢åŠ jçš„å€¼
   75          //-------------------------------------------------------------------------------------------------------
             -------------
   76          static void dl1b_simiic_delay(void)
   77          {
   78   1          uint16 j=DL1B_SOFT_IIC_DELAY;   
   79   1              while(j--);
   80   1      }
   81          
   82          //å†…éƒ¨ä½¿ç”¨ï¼Œç”¨æˆ·æ— éœ€è°ƒç”¨
   83          static void dl1b_simiic_start(void)
   84          {
   85   1              DL1B_SDA_HIGH();
   86   1              DL1B_SCL_HIGH();
   87   1              dl1b_simiic_delay();
   88   1              DL1B_SDA_LOW();
   89   1              dl1b_simiic_delay();
   90   1              DL1B_SCL_LOW();
   91   1      }
   92          
   93          //å†…éƒ¨ä½¿ç”¨ï¼Œç”¨æˆ·æ— éœ€è°ƒç”¨
   94          static void dl1b_simiic_stop(void)
   95          {
   96   1              DL1B_SDA_LOW();
   97   1              DL1B_SCL_LOW();
   98   1              dl1b_simiic_delay();
   99   1              DL1B_SCL_HIGH();
  100   1              dl1b_simiic_delay();
  101   1              DL1B_SDA_HIGH();
  102   1              dl1b_simiic_delay();
  103   1      }
  104          
  105          //ä¸»åº”ç­”(åŒ…å«ack:SDA=0å’Œno_ack:SDA=0)
  106          //å†…éƒ¨ä½¿ç”¨ï¼Œç”¨æˆ·æ— éœ€è°ƒç”¨
  107          static void dl1b_simiic_sendack(unsigned char ack_dat)
  108          {
  109   1          DL1B_SCL_LOW();
  110   1              dl1b_simiic_delay();
  111   1              if(ack_dat) DL1B_SDA_LOW();
C251 COMPILER V5.60.0,  SEEKFREE_DL1B                                                      13/07/23  14:12:17  PAGE 3   

  112   1          else        DL1B_SDA_HIGH();
  113   1      
  114   1          DL1B_SCL_HIGH();
  115   1          dl1b_simiic_delay();
  116   1          DL1B_SCL_LOW();
  117   1          dl1b_simiic_delay();
  118   1      }
  119          
  120          
  121          static int dl1b_sccb_waitack(void)
  122          {
  123   1          DL1B_SCL_LOW();
  124   1      
  125   1              dl1b_simiic_delay();
  126   1              
  127   1              DL1B_SCL_HIGH();
  128   1          dl1b_simiic_delay();
  129   1              
  130   1          if(GET_DL1B_SDA)           //åº”ç­”ä¸ºé«˜ç”µå¹³ï¼Œå¼‚å¸¸ï¼Œé€šä¿¡å¤±è´¥
  131   1          {
  132   2      
  133   2              DL1B_SCL_LOW();
  134   2              return 0;
  135   2          }
  136   1      
  137   1          DL1B_SCL_LOW();
  138   1              dl1b_simiic_delay();
  139   1          return 1;
  140   1      }
  141          
  142          //å­—èŠ‚å‘é€ç¨‹åº
  143          //å‘é€c(å¯ä»¥æ˜¯æ•°æ®ä¹Ÿå¯æ˜¯åœ°å€)ï¼Œé€å®Œåæ¥æ”¶ä»åº”ç­”
  144          //ä¸è€ƒè™‘ä»åº”ç­”ä½
  145          //å†…éƒ¨ä½¿ç”¨ï¼Œç”¨æˆ·æ— éœ€è°ƒç”¨
  146          static void dl1b_send_ch(uint8 c)
  147          {
  148   1              uint8 i = 8;
  149   1          while(i--)
  150   1          {
  151   2              if(c & 0x80)    DL1B_SDA_HIGH();//SDA è¾“å‡ºæ•°æ®
  152   2              else                    DL1B_SDA_LOW();
  153   2              c <<= 1;
  154   2              dl1b_simiic_delay();
  155   2              DL1B_SCL_HIGH();                //SCL æ‹‰é«˜ï¼Œé‡‡é›†ä¿¡å·
  156   2              dl1b_simiic_delay();
  157   2              DL1B_SCL_LOW();                //SCL æ—¶é’Ÿçº¿æ‹‰ä½
  158   2          }
  159   1              dl1b_sccb_waitack();
  160   1      }
  161          
  162          
  163          //å­—èŠ‚æ¥æ”¶ç¨‹åº
  164          //æ¥æ”¶å™¨ä»¶ä¼ æ¥çš„æ•°æ®ï¼Œæ­¤ç¨‹åºåº”é…åˆ|ä¸»åº”ç­”å‡½æ•°|ä½¿ç”¨
  165          //å†…éƒ¨ä½¿ç”¨ï¼Œç”¨æˆ·æ— éœ€è°ƒç”¨
  166          static uint8 dl1b_read_ch(uint8 ack_x)
  167          {
  168   1          uint8 i;
  169   1          uint8 c;
  170   1          c=0;
  171   1          DL1B_SCL_LOW();
  172   1          dl1b_simiic_delay();
  173   1          DL1B_SDA_HIGH();             
  174   1      
  175   1          for(i=0;i<8;i++)
  176   1          {
  177   2              dl1b_simiic_delay();
C251 COMPILER V5.60.0,  SEEKFREE_DL1B                                                      13/07/23  14:12:17  PAGE 4   

  178   2              DL1B_SCL_LOW();         //ç½®æ—¶é’Ÿçº¿ä¸ºä½ï¼Œå‡†å¤‡æ¥æ”¶æ•°æ®ä½
  179   2              dl1b_simiic_delay();
  180   2              DL1B_SCL_HIGH();         //ç½®æ—¶é’Ÿçº¿ä¸ºé«˜ï¼Œä½¿æ•°æ®çº¿ä¸Šæ•°æ®æœ‰æ•ˆ
  181   2              dl1b_simiic_delay();
  182   2              c<<=1;
  183   2              if(GET_DL1B_SDA) 
  184   2              {
  185   3                  c+=1;   //è¯»æ•°æ®ä½ï¼Œå°†æ¥æ”¶çš„æ•°æ®å­˜c
  186   3              }
  187   2          }
  188   1      
  189   1              DL1B_SCL_LOW();
  190   1              dl1b_simiic_delay();
  191   1              dl1b_simiic_sendack(ack_x);
  192   1              
  193   1          return c;
  194   1      }
  195          
  196          
  197          //-------------------------------------------------------------------------------------------------------
             -------------
  198          // å‡½æ•°ç®€ä»‹     è½¯ä»¶ IIC æ¥å£ä¼ è¾“ 8bit æ•°ç»„ å…ˆå†™åè¯»å–
  199          // å‚æ•°è¯´æ˜     *write_data     å‘é€æ•°æ®å­˜æ”¾ç¼“å†²åŒº
  200          // å‚æ•°è¯´æ˜     write_len       å‘é€ç¼“å†²åŒºé•¿åº¦
  201          // å‚æ•°è¯´æ˜     *read_data      è¯»å–æ•°æ®å­˜æ”¾ç¼“å†²åŒº
  202          // å‚æ•°è¯´æ˜     read_len        è¯»å–ç¼“å†²åŒºé•¿åº¦
  203          // è¿”å›å‚æ•°     void            
  204          // ä½¿ç”¨ç¤ºä¾‹     iic_transfer_8bit_array(IIC_1, addr, data, 64, data, 64);
  205          // å¤‡æ³¨ä¿¡æ¯     
  206          //-------------------------------------------------------------------------------------------------------
             -------------
  207          void dl1b_iic_transfer_8bit_array (const uint8 *write_data, uint32 write_len, uint8 *read_data, uint32 re
             -ad_len)
  208          {
  209   1      
  210   1          dl1b_simiic_start();
  211   1          dl1b_send_ch(DL1B_DEV_ADDR << 1);
  212   1          while(write_len --)
  213   1          {
  214   2              dl1b_send_ch(*write_data ++);
  215   2          }
  216   1          dl1b_simiic_start();
  217   1          dl1b_send_ch(DL1B_DEV_ADDR << 1 | 0x01);
  218   1          while(read_len --)
  219   1          {
  220   2                      // å‰é¢7ä½éœ€è¦å›å¤ackï¼Œæœ€å1ä½ä¸éœ€è¦å›å¤ack.
  221   2              *read_data ++ = dl1b_read_ch(read_len != 0);
  222   2          }
  223   1          dl1b_simiic_stop();
  224   1      }
  225          
  226          
  227          
  228          
  229          
  230          //-------------------------------------------------------------------------------------------------------
             -------------
  231          // å‡½æ•°ç®€ä»‹     è¿”å›ä»¥æ¯«ç±³ä¸ºå•ä½çš„èŒƒå›´è¯»æ•°
  232          // å‚æ•°è¯´æ˜     void
  233          // è¿”å›å‚æ•°     void
  234          // ä½¿ç”¨ç¤ºä¾‹     dl1b_get_distance();
  235          // å¤‡æ³¨ä¿¡æ¯     åœ¨å¼€å§‹å•æ¬¡å°„ç¨‹æµ‹é‡åä¹Ÿè°ƒç”¨æ­¤å‡½æ•°
  236          //-------------------------------------------------------------------------------------------------------
             -------------
  237          void dl1b_get_distance (void)
  238          {
C251 COMPILER V5.60.0,  SEEKFREE_DL1B                                                      13/07/23  14:12:17  PAGE 5   

  239   1          if(dl1b_init_flag)
  240   1          {
  241   2              uint8 data_buffer[3];
  242   2              int16 dl1b_distance_temp = 0;
  243   2      
  244   2              data_buffer[0] = DL1B_GPIO__TIO_HV_STATUS >> 8;
  245   2              data_buffer[1] = DL1B_GPIO__TIO_HV_STATUS & 0xFF;
  246   2              dl1b_transfer_8bit_array(data_buffer, 2, &data_buffer[2], 1);
  247   2      
  248   2              if(data_buffer[2])
  249   2              {
  250   3      
  251   3                  data_buffer[0] = DL1B_SYSTEM__INTERRUPT_CLEAR >> 8;
  252   3                  data_buffer[1] = DL1B_SYSTEM__INTERRUPT_CLEAR & 0xFF;
  253   3                  data_buffer[2] = 0x01;
  254   3                  dl1b_transfer_8bit_array(data_buffer, 3, data_buffer, 0);// clear Interrupt
  255   3      
  256   3                  data_buffer[0] = DL1B_RESULT__RANGE_STATUS >> 8;
  257   3                  data_buffer[1] = DL1B_RESULT__RANGE_STATUS & 0xFF;
  258   3                  dl1b_transfer_8bit_array(data_buffer, 2, &data_buffer[2], 1);
  259   3                  
  260   3                  if(0x89 == data_buffer[2])
  261   3                  {
  262   4                      data_buffer[0] = DL1B_RESULT__FINAL_CROSSTALK_CORRECTED_RANGE_MM_SD0 >> 8;
  263   4                      data_buffer[1] = DL1B_RESULT__FINAL_CROSSTALK_CORRECTED_RANGE_MM_SD0 & 0xFF;
  264   4                      dl1b_transfer_8bit_array(data_buffer, 2, data_buffer, 2);
  265   4                      dl1b_distance_temp = data_buffer[0];
  266   4                      dl1b_distance_temp = (dl1b_distance_temp << 8) | data_buffer[1];
  267   4                      
  268   4                      if(dl1b_distance_temp > 4000 || dl1b_distance_temp < 0)
  269   4                      {
  270   5                          dl1b_distance_mm = 8192;
  271   5                          dl1b_finsh_flag = 0;
  272   5                      }
  273   4                      else
  274   4                      {
  275   5                          dl1b_distance_mm = dl1b_distance_temp;
  276   5                          dl1b_finsh_flag = 1;
  277   5                      }
  278   4                  }
  279   3                  else
  280   3                  {
  281   4                      dl1b_distance_mm = 8192;
  282   4                      dl1b_finsh_flag = 0;
  283   4                  }
  284   3              }
  285   2              else
  286   2              {
  287   3                  dl1b_distance_mm = 8192;
  288   3                  dl1b_finsh_flag = 0;
  289   3              }
  290   2          }
  291   1      }
  292          
  293          
  294          
  295          //-------------------------------------------------------------------------------------------------------
             -------------
  296          // å‡½æ•°ç®€ä»‹     åˆå§‹åŒ– DL1B
  297          // å‚æ•°è¯´æ˜     void
  298          // è¿”å›å‚æ•°     uint8           1-åˆå§‹åŒ–å¤±è´¥ 0-åˆå§‹åŒ–æˆåŠŸ
  299          // ä½¿ç”¨ç¤ºä¾‹     dl1b_init();
  300          // å¤‡æ³¨ä¿¡æ¯
  301          //-------------------------------------------------------------------------------------------------------
             -------------
  302          uint8 dl1b_init (void)
C251 COMPILER V5.60.0,  SEEKFREE_DL1B                                                      13/07/23  14:12:17  PAGE 6   

  303          {
  304   1          uint8   return_state    = 0;
  305   1          uint8   data_buffer[2 + sizeof(dl1b_default_configuration)]; 
  306   1          uint16  time_out_count  = 0;
  307   1      
  308   1      
  309   1          do
  310   1          {
  311   2              delay_ms(50);
  312   2              DL1B_XS_PIN = 0;
  313   2              delay_ms(10);
  314   2              DL1B_XS_PIN = 1;
  315   2              delay_ms(50);
  316   2      
  317   2              data_buffer[0] = DL1B_FIRMWARE__SYSTEM_STATUS >> 8;
  318   2              data_buffer[1] = DL1B_FIRMWARE__SYSTEM_STATUS & 0xFF;
  319   2              dl1b_transfer_8bit_array(data_buffer, 2, &data_buffer[2], 1);
  320   2              return_state = (0x01 == (data_buffer[2] & 0x01)) ? (0) : (1);
  321   2              if(1 == return_state)
  322   2              {
  323   3                  break;
  324   3              }
  325   2      
  326   2              data_buffer[0] = DL1B_I2C_SLAVE__DEVICE_ADDRESS >> 8;
  327   2              data_buffer[1] = DL1B_I2C_SLAVE__DEVICE_ADDRESS & 0xFF;
  328   2              memcpy(&data_buffer[2], (uint8 *)dl1b_default_configuration, sizeof(dl1b_default_configuration));
  329   2              dl1b_transfer_8bit_array(data_buffer, 2 + sizeof(dl1b_default_configuration), data_buffer, 0);
  330   2      
  331   2              while(1)
  332   2              {
  333   3                  data_buffer[0] = DL1B_GPIO__TIO_HV_STATUS >> 8;
  334   3                  data_buffer[1] = DL1B_GPIO__TIO_HV_STATUS & 0xFF;
  335   3                  dl1b_transfer_8bit_array(data_buffer, 2, &data_buffer[2], 1);
  336   3                  if(0x00 == (data_buffer[2] & 0x01))
  337   3                  {
  338   4                      time_out_count = 0;
  339   4                      break;
  340   4                  }
  341   3                  if(DL1B_TIMEOUT_COUNT < time_out_count ++)
  342   3                  {
  343   4                      return_state = 1;
  344   4                      break;
  345   4                  }
  346   3                  delay_ms(1);
  347   3              }
  348   2      
  349   2              dl1b_init_flag = 1;
  350   2          }while(0);
  351   1      
  352   1      
  353   1          return return_state;
  354   1      }


Module Information          Static   Overlayable
------------------------------------------------
  code size            =      1255     ------
  ecode size           =    ------     ------
  data size            =    ------     ------
  idata size           =    ------     ------
  pdata size           =    ------     ------
  xdata size           =       173     ------
  xdata-const size     =    ------     ------
  edata size           =    ------     ------
  bit size             =    ------     ------
  ebit size            =    ------     ------
  bitaddressable size  =    ------     ------
C251 COMPILER V5.60.0,  SEEKFREE_DL1B                                                      13/07/23  14:12:17  PAGE 7   

  ebitaddressable size =    ------     ------
  far data size        =    ------     ------
  huge data size       =    ------     ------
  const size           =    ------     ------
  hconst size          =        19     ------
End of Module Information.


C251 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
